name: Publish Alpha Bug Baseline

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, only log which issues would be created."
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync alpha bug issues
        uses: actions/github-script@v7
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'docs/alpha-bugs.json';
            if (!fs.existsSync(path)) {
              core.setFailed(`Missing ${path}; nothing to publish.`);
              return;
            }
            const bugs = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!Array.isArray(bugs) || bugs.length === 0) {
              core.info('No bugs defined; skipping.');
              return;
            }

            const dryRun = (process.env.DRY_RUN || 'false').toLowerCase() === 'true';
            const { owner, repo } = context.repo;

            for (const bug of bugs) {
              if (!bug.title || !bug.body) {
                core.warning(`Skipping malformed entry: ${JSON.stringify(bug)}`);
                continue;
              }

              const search = await github.rest.search.issuesAndPullRequests({
                q: `repo:${owner}/${repo} is:issue "${bug.title}" in:title`
              });

              const existing = search.data.items.find(item => item.title.toLowerCase() === bug.title.toLowerCase() && item.state === 'open');
              if (existing) {
                core.info(`Issue already exists for "${bug.title}" (#${existing.number}); skipping.`);
                continue;
              }

              if (dryRun) {
                core.info(`[DRY RUN] Would create issue "${bug.title}" with labels ${(bug.labels || []).join(', ') || '(none)'}.`);
                continue;
              }

              const response = await github.rest.issues.create({
                owner,
                repo,
                title: bug.title,
                body: bug.body,
                labels: bug.labels || ['bug']
              });
              core.info(`Created issue #${response.data.number} for "${bug.title}".`);
            }
