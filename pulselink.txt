PulseLink Build Notes
=====================

Created: 2025-11-02

-- Overview --
PulseLink is a clean-room rebuild of the emergency phrase app. It includes continuous speech recognition, SMS escalation, high-priority notifications, and contact management without blocking any messaging flows.

-- 2025-11-02 Update --
- Confirmed new audio assets present in `androidApp/src/main/res/raw`.
- Rebuilt `androidApp:assembleDebug` on 2025-11-02 01:29 local; output at `androidApp/build/outputs/apk/debug/androidApp-debug.apk`.
- Verified the rebuilt APK bundles the raw audio via `unzip -l`.
- Next step: install the 2025-11-02 build on a device and confirm each alert sound plays end-to-end.
- Cleaned Gradle artifacts (`androidApp/build`, project-level `.gradle`) ahead of initial commit.
- Added `PulseLink-ui-mockup/` sketches (1.png-6.png) to track UI direction.
- Removed bundled Gradle distribution artifacts to stay under GitHub size limits.
- Initial snapshot pushed to GitHub: `DamienLove/thepulselinkapp` (branch `main`).
- Introduced `free` (ads) and `pro` (paid) flavors; debug APKs at `androidApp/build/outputs/apk/free/debug/androidApp-free-debug.apk` and `androidApp/build/outputs/apk/pro/debug/androidApp-pro-debug.apk`.
- Free flavor now loads AdMob app-open, native card, and banner slots when the in-app “Pro mode” switch is turned off.
- Home top bar now shows the branded icon beside the PulseLink title; flavor app names updated (“PulseLink” vs “PulseLink Pro”).
- Foreground service start gated until microphone permission granted to satisfy Android 14 FGS requirements.
- Dropped the unused `dataSync` foreground-service type and disabled auto-start listening so first launch lands on the new Home dashboard.
- Implemented splash, onboarding, and redesigned home/dashboard with listening switch, navigation tiles, contact list with call/message shortcuts, and pro upgrade card.
- Wired the SMS command pipeline: link requests/approvals, pings, and remote alert preparation now move through `ContactLinkManager` with DND overrides.
- Added per-contact linking state, remote permission toggles, and the official PulseLink shield artwork (launcher + in-app logo).
- Current focus (branch `feature/ui-polish`): tighten back-stack behavior, swap the emergency tier toggle for an outgoing ringer selector, finalize inbound approval/ping UX, request DND access up front, and restore ringer/DND state after alerts.

-- Modules --
androidApp: Compose UI + Hilt + Room + DataStore + WorkManager integration for long-running foreground services.

-- Quick Run --
1. Install Temurin JDK 17.
2. Generate Gradle wrapper jars (if missing) with gradle wrapper --gradle-version 8.6.
3. Execute ./gradlew androidApp:assembleDebug.
4. Deploy via adb install androidApp/build/outputs/apk/debug/androidApp-debug.apk.

-- Key Services --
- PulseLinkForegroundService: Maintains ongoing notification + spawns PulseLinkVoiceService for hotword capture.
- PulseLinkVoiceService: SpeechRecognizer loop that feeds AlertRouter.
- AlertRouter: Resolves phrases to escalation tiers and uses AlertDispatcher for SMS + notifications.

-- Permissions --
App requests microphone, SMS (send/receive), notification, and location access. Behaviors degrade gracefully when any permission is denied.
-- 2025-11-03 Update --
- Replaced static alert/check-in channels with per-tone notification channels that always reference the bundled raw assets and respect vibration/DND flags.
- Added AudioOverrideManager to snapshot/restore ring volume, ringer mode, and interruption filter; removed the RestoreRingerReceiver broadcast.
- RemoteActionHandler now funnels remote overrides through the AudioOverrideManager for consistent restore behavior.
- Next steps: finish UI cleanup (remove legacy widgets, relocate Alerts/Settings) and implement remote handshake + DND access prompts.
- Streamlined Home UI: removed unused navigation buttons, moved alerts management into Alerts screen, and added Settings destination with location toggle.
- Added remote alert handshake: devices now exchange prepare/ready SMS codes, enforce DND access before remote alerts or pings, and fall back gracefully if overrides fail.
- Onboarding now detects external permission grants and provides app-settings guidance for stubborn SMS approvals.

-- 2025-11-04 Update --
- Remote contact attention flow now plays the configured alert tone (respecting per-contact overrides) for pings, manual messages, and remote handshakes while forcing ring volume/DND overrides and scheduling automatic restore.
- Manual message and ping senders receive immediate feedback if the remote device fails to acknowledge the override; manual composer blocks unlinked contacts and preserves guidance to try again if delivery raises an error.
- Notification sound picker now manages preview playback via a single MediaPlayer instance that stops/cleans up when leaving the screen.
- Onboarding permission help clarified the SMS unlock steps (Settings > Apps > PulseLink > Permissions > 3-dot menu) per Motorola fingerprint flows.
- Contact detail and home actions now await handshake completion, show success/fallback toasts, and refuse remote messaging until the contact is fully linked.
- Restored the Pro upsell card on Home so the existing navigation entry no longer references a missing composable.
- Built fresh free/pro debug APKs on 2025-11-04 (`androidApp/build/outputs/apk/free/debug/androidApp-free-debug.apk`, `androidApp/build/outputs/apk/pro/debug/androidApp-pro-debug.apk`).

-- 2025-11-04 Update (UI/Messaging) --
- Split onboarding into a welcome overview + name capture screen followed by a dedicated permissions step that blocks completion until SMS, contacts, microphone, location, notifications, and DND access are all granted.
- Added a persistent DND access action in Settings so users can re-enable overrides after onboarding.
- Logged manual messages (inbound/outbound) via a new `contact_messages` table and repository; conversations now persist across app restarts.
- Replaced the contact detail messaging dialog with a full-screen conversation surface inspired by the new design mock (`branding/PulseLink.png`) including gradient bubbles, logo header, status pills, and quick ping access.
- Added a gear icon beside each home contact to jump straight into that contact's settings, while tapping the card opens the conversation view.
- Rebuilt the message composer with gradient styling, mic icon placeholder, and override feedback chips on outbound messages.
- Confirmed fresh `androidApp:assembleProDebug` and `androidApp:assembleFreeDebug` builds on 2025-11-04 after the UI overhaul.
- Restored the one-tap "Grant permissions" button on the onboarding permissions screen so users can launch the system dialogs without leaving the flow, while still blocking final completion until every grant (including DND) succeeds.

-- 2025-11-05 Update --
- Implemented end-to-end SMS delivery tracking with a new `SmsSendReceiver`, PendingIntent callbacks, and deferred completion so manual message send states reflect real modem results.
- Hardened inbound manual message handling by retrying contact resolution, guarding against ID 0 saves, and flagging outbound results as pending when the remote contact has not approved linking.
- Polished the onboarding, home, and settings composables with the latest gradients, toggle cards, and permission guidance; fixed the onboarding name field cursor jump reported by QA.
- Gradle targets `testFreeDebugUnitTest`, `testProDebugUnitTest`, and `androidApp:assembleProDebug` now pass against the refreshed branch (see `androidApp/build/outputs/apk/pro/debug/` for the updated APK).
- Reworked the contact call flow to wait for remote override confirmation, auto place the call via `ACTION_CALL`, monitor call completion, and push a `CallEnded` SMS so the receiver's audio settings restore immediately after hangup.

-- 2025-11-05 Update (Alert polish & UI) --
- Emergency quick action now dispatches alerts to ordered contacts sequentially and keeps remote ringers elevated through the follow-up call handshake.
- Contact call flow waits on the new AlertPrepare(CALL) handshake, sends CallEnded acknowledgements, and auto-restores remote audio overrides after hangup.
- Link approval screen surfaces an "Allow remote sound change" switch and respects the auto-allow setting during approval.
- Home header/logo alignment, mic toggle copy, quick actions, and reorder affordances refreshed; Settings gained a listening toggle and clearer tone entries.
- Tone pickers open as dedicated routes for emergency vs. check-in sounds with cleaned layouts and centered branding.
- Updated theme palettes and component styling to improve contrast in light/dark modes across settings, contact detail, and dialog surfaces.
- Contact import pipeline now guards permission failures and returns a user-facing toast instead of crashing.

-- 2025-11-06 Update (Release signing & Play requirements) --
- Migrated the app to API Level 35: `compileSdk = 35`, `targetSdk = 35`, `buildToolsVersion = 35.0.0`, `versionCode = 3`, `versionName = 1.0.2` to satisfy Play's November 2025 policy.
- Added a configurable release signing block in Gradle that resolves credentials from `keystore.properties`, environment variables, or `-P android.injected.signing.*`. Defaults now point to the legacy `upload-keystore.jks` so we continue matching the Play upload certificate (SHA1 `38:48:65:74:6B:F3:20:26:47:81:7A:76:63:03:C3:33:6D:9A:45:D3`).
- Committed `keystore.properties.template` documenting the required fields; the real `keystore.properties` remains git-ignored and must contain the legacy keystore path, alias, and passwords.
- Updated `.github/workflows/release-aab.yml` to pass signing credentials via env vars and build both free/pro release bundles before calling `r0adkll/upload-google-play@v1`.
- Local verification (2025-11-06 11:27 MST): `./gradlew clean bundleFreeRelease bundleProRelease assembleFreeRelease assembleProRelease`; outputs land in `androidApp/build/outputs/{bundle,apk}/**/release/`. Note: builds must be re-signed with the legacy key prior to Play upload.
- Play Console rejected the latest bundle because it was signed with a new key. Resign with the original upload keystore (fingerprint above) or initiate a managed key reset via Play support before the next submission.

Next Immediate actions:
- Restore the original upload keystore credentials in `keystore.properties` (or CI secrets) so CI and local builds sign with the expected certificate before retrying the Play upload.
- Coordinate with Play Console admins to confirm the service account still has Release Manager access and that the Google Play Android Developer API is enabled, then rerun the internal track release once the signature matches.
- Address the outstanding UX polish from 2025-11-05: emergency quick action button, contact reorder drag support, tone picker separation with centered branding, link-approval toggle for "allow remote sound change", contrast fixes, centered logo + mic toggle on Home, removal of the stray "support circle" icon, and the contact import crash.
- Re-run end-to-end smoke tests (alerts, SMS flows, contact linking) once the UI changes land, then cut the next internal track build via the refreshed GitHub workflow.

-- 2025-11-07 Update (Alpha baseline + signing assets) --
- Declared `<uses-feature android.hardware.telephony android:required="false" />` so ChromeOS devices (and lint) treat SMS/phone capabilities as optional-resolves the Play Console install block encountered on Chromebooks.
- Fixed `NativeAdCard` to inflate `native_ad_view` into a `NativeAdView` container before binding, restoring padding/rounded corners on the Upgrade-to-Pro placement.
- Added `docs/alpha-bugs.json` plus the `Publish Alpha Bug Baseline` workflow that turns each JSON entry into a GitHub issue. First run (workflow #2) created Issues #15 and #16 for the ChromeOS telephony flag + native ad layout regressions.
- Granted the workflow `issues: write` scope via workflow-level `permissions` so it can open tickets using the default `GITHUB_TOKEN`-no PAT required. Trigger it from GitHub Actions (supports a `dry_run` boolean).
- Dropped the new Play upload certificate (`upload_certificate.pem`) into the repo root. Use this PEM when Play requests proof of the active upload key while keeping the actual signing keystore (`upload-keystore.jks`) and passwords outside the repo. Always sign release artifacts with the legacy upload key before submitting the next build.

-- 2025-11-09 Update (Home scroll + reliable overrides) --
- Home screen now declares a shared `rememberScrollState()` and applies `verticalScroll` to the root `Column`, so the navigation tiles, quick actions, contact list, and ads remain reachable on compact phones.
- The header logo shrank from 132.dp to 99.dp (75% scale) to reclaim vertical space without losing brand presence.
- Remote action handling forces DND overrides for emergency tiers regardless of per-contact settings: `prepareForAlert()` always boosts audio for emergency/call reasons, and `playAttentionTone()` now requests bypass + loops tones for emergency tiers.
- Emergency notifications explicitly call `AudioOverrideManager.playTone()` so receivers always hear the configured siren even if the notification channel sound was customized.
-- 2025-11-09 Update --
- Removed the always-on microphone foreground service and the broken Hands-free listening toggle.
- Added Google Assistant voice shortcuts ("Hey Google, PulseLink emergency/check-in") via AssistantShortcutActivity and dynamic shortcuts.
- Settings/Home now guide reviewers to enable the Assistant shortcut, and the manifest drops RECORD_AUDIO/foreground-service permissions.
- Rebuilt free (com.free.pulselink) and pro bundles with the updated signing keys.


\n-- 2025-11-09 Update --\n- Added remote alert automation so pressing Emergency also sends AlertPrepare/RemoteAlert control SMS to linked contacts, ensuring their devices arm the siren even before the human-readable SMS lands.\n- AudioOverrideManager now manages STREAM_ALARM alongside ring/notification streams, requests transient audio focus, and surfaces structured status (success/partial/missing permission) to the UI.\n- RemoteActionHandler and ContactLinkManager propagate the override status and insert short delays so Samsung devices apply volume changes before sirens fire.\n- Settings and onboarding flows now guide users through DND changes (Android 15+ channel bypass) and request CALL_PHONE permission up front to avoid surprises during the first escalation call.\n- release-aab GitHub workflow uploads both free (com.free.pulselink) and pro (com.pulselink.pro) bundles automatically to the selected Play track.\n

-- 2025-11-09 Update --
- Added remote alert automation so pressing Emergency also sends AlertPrepare/RemoteAlert control SMS to linked contacts, ensuring their devices arm the siren even before the human-readable SMS lands.
- AudioOverrideManager now manages STREAM_ALARM alongside ring/notification streams, requests transient audio focus, and surfaces structured status (success/partial/missing permission) to the UI.
- RemoteActionHandler and ContactLinkManager propagate the override status and insert short delays so Samsung devices apply volume changes before sirens fire.
- Settings and onboarding flows now guide users through DND changes (Android 15+ channel bypass) and request CALL_PHONE permission up front to avoid surprises during the first escalation call.
- release-aab GitHub workflow uploads both free (com.free.pulselink) and pro (com.pulselink.pro) bundles automatically to the selected Play track.
- In-app bug reporting now opens the GitHub Pages portal (auto-prefilled) so submissions file directly into Issues.

-- 2025-11-11 Update (DND policy + Assistant hint) --
- AudioOverrideManager now adheres to Android 15's priority-based DND rules: we expand the NotificationManager.Policy to allow alarms/media/calls, request PRIORITY instead of ALL on V-IC devices, and log when OEM policies still limit the override. Legacy devices continue to flip the full interruption filter, so sirens break through again without Play warnings.
- Home screen Assistant hint can be dismissed via the new close affordance; the dismissal flag is persisted in DataStore (PulseLinkSettings.assistantShortcutsDismissed) so reviewers who don't have Google Assistant (e.g., Gemini-only devices) aren't stuck with a dead card. Settings still expose the shortcut launcher for manual enablement.
- GitHub Actions `release-aab.yml` now decodes two signing keystores: Free keeps the existing `UPLOAD_KEYSTORE_*` secrets, while Pro reads `${{ secrets.PRO_UPLOAD_KEYSTORE_BASE64 }}` + `PRO_KEYSTORE_PASSWORD/PRO_KEY_ALIAS/PRO_KEY_PASSWORD`. Gradle picks them up via the `_PRO` environment suffixes when bundling the pro flavor.
- The release workflow also adds `upload_free`, `upload_pro`, `track_free`, and `track_pro` inputs so we can publish variants independently (no more forced dual uploads or mismatched tracks). The Gradle step only bundles the flavors that are toggled on, mitigating the Play upload failures we kept seeing when Pro credentials weren't ready yet.
- New Firebase real-time channel (Firestore) sits beside SMS: manual messages now try the encrypted data path first when both devices are linked + online, then fall back to SMS automatically if Firestore fails. Incoming realtime messages feed the existing tone/notification pipeline so receivers still get the audio override, and all traffic is persisted to `contact_messages` for continuity.
