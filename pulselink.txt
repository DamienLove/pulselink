PulseLink Build Notes
=====================

Created: 2025-11-02

-- Overview --
PulseLink is a clean-room rebuild of the emergency phrase app. It includes continuous speech recognition, SMS escalation, high-priority notifications, and contact management without blocking any messaging flows.

-- 2025-11-02 Update --
- Confirmed new audio assets present in `androidApp/src/main/res/raw`.
- Rebuilt `androidApp:assembleDebug` on 2025-11-02 01:29 local; output at `androidApp/build/outputs/apk/debug/androidApp-debug.apk`.
- Verified the rebuilt APK bundles the raw audio via `unzip -l`.
- Next step: install the 2025-11-02 build on a device and confirm each alert sound plays end-to-end.
- Cleaned Gradle artifacts (`androidApp/build`, project-level `.gradle`) ahead of initial commit.
- Added `PulseLink-ui-mockup/` sketches (1.png-6.png) to track UI direction.
- Removed bundled Gradle distribution artifacts to stay under GitHub size limits.
- Initial snapshot pushed to GitHub: `DamienLove/thepulselinkapp` (branch `main`).
- Introduced `free` (ads) and `pro` (paid) flavors; debug APKs at `androidApp/build/outputs/apk/free/debug/androidApp-free-debug.apk` and `androidApp/build/outputs/apk/pro/debug/androidApp-pro-debug.apk`.
- Free flavor now loads AdMob app-open, native card, and banner slots when the in-app “Pro mode” switch is turned off.
- Home top bar now shows the branded icon beside the PulseLink title; flavor app names updated (“PulseLink” vs “PulseLink Pro”).
- Foreground service start gated until microphone permission granted to satisfy Android 14 FGS requirements.
- Dropped the unused `dataSync` foreground-service type and disabled auto-start listening so first launch lands on the new Home dashboard.
- Implemented splash, onboarding, and redesigned home/dashboard with listening switch, navigation tiles, contact list with call/message shortcuts, and pro upgrade card.
- Wired the SMS command pipeline: link requests/approvals, pings, and remote alert preparation now move through `ContactLinkManager` with DND overrides.
- Added per-contact linking state, remote permission toggles, and the official PulseLink shield artwork (launcher + in-app logo).
- Current focus (branch `feature/ui-polish`): tighten back-stack behavior, swap the emergency tier toggle for an outgoing ringer selector, finalize inbound approval/ping UX, request DND access up front, and restore ringer/DND state after alerts.

-- Modules --
androidApp: Compose UI + Hilt + Room + DataStore + WorkManager integration for long-running foreground services.

-- Quick Run --
1. Install Temurin JDK 17.
2. Generate Gradle wrapper jars (if missing) with gradle wrapper --gradle-version 8.6.
3. Execute ./gradlew androidApp:assembleDebug.
4. Deploy via adb install androidApp/build/outputs/apk/debug/androidApp-debug.apk.

-- Key Services --
- PulseLinkForegroundService: Maintains ongoing notification + spawns PulseLinkVoiceService for hotword capture.
- PulseLinkVoiceService: SpeechRecognizer loop that feeds AlertRouter.
- AlertRouter: Resolves phrases to escalation tiers and uses AlertDispatcher for SMS + notifications.

-- Permissions --
App requests microphone, SMS (send/receive), notification, and location access. Behaviors degrade gracefully when any permission is denied.
-- 2025-11-03 Update --
- Replaced static alert/check-in channels with per-tone notification channels that always reference the bundled raw assets and respect vibration/DND flags.
- Added AudioOverrideManager to snapshot/restore ring volume, ringer mode, and interruption filter; removed the RestoreRingerReceiver broadcast.
- RemoteActionHandler now funnels remote overrides through the AudioOverrideManager for consistent restore behavior.
- Next steps: finish UI cleanup (remove legacy widgets, relocate Alerts/Settings) and implement remote handshake + DND access prompts.
- Streamlined Home UI: removed unused navigation buttons, moved alerts management into Alerts screen, and added Settings destination with location toggle.
- Added remote alert handshake: devices now exchange prepare/ready SMS codes, enforce DND access before remote alerts or pings, and fall back gracefully if overrides fail.
- Onboarding now detects external permission grants and provides app-settings guidance for stubborn SMS approvals.

-- 2025-11-04 Update --
- Remote contact attention flow now plays the configured alert tone (respecting per-contact overrides) for pings, manual messages, and remote handshakes while forcing ring volume/DND overrides and scheduling automatic restore.
- Manual message and ping senders receive immediate feedback if the remote device fails to acknowledge the override; manual composer blocks unlinked contacts and preserves guidance to try again if delivery raises an error.
- Notification sound picker now manages preview playback via a single MediaPlayer instance that stops/cleans up when leaving the screen.
- Onboarding permission help clarified the SMS unlock steps (Settings > Apps > PulseLink > Permissions > 3-dot menu) per Motorola fingerprint flows.
- Contact detail and home actions now await handshake completion, show success/fallback toasts, and refuse remote messaging until the contact is fully linked.
- Restored the Pro upsell card on Home so the existing navigation entry no longer references a missing composable.
- Built fresh free/pro debug APKs on 2025-11-04 (`androidApp/build/outputs/apk/free/debug/androidApp-free-debug.apk`, `androidApp/build/outputs/apk/pro/debug/androidApp-pro-debug.apk`).

-- 2025-11-04 Update (UI/Messaging) --
- Split onboarding into a welcome overview + name capture screen followed by a dedicated permissions step that blocks completion until SMS, contacts, microphone, location, notifications, and DND access are all granted.
- Added a persistent DND access action in Settings so users can re-enable overrides after onboarding.
- Logged manual messages (inbound/outbound) via a new `contact_messages` table and repository; conversations now persist across app restarts.
- Replaced the contact detail messaging dialog with a full-screen conversation surface inspired by the new design mock (`branding/PulseLink.png`) including gradient bubbles, logo header, status pills, and quick ping access.
- Added a gear icon beside each home contact to jump straight into that contact's settings, while tapping the card opens the conversation view.
- Rebuilt the message composer with gradient styling, mic icon placeholder, and override feedback chips on outbound messages.
- Confirmed fresh `androidApp:assembleProDebug` and `androidApp:assembleFreeDebug` builds on 2025-11-04 after the UI overhaul.
- Restored the one-tap "Grant permissions" button on the onboarding permissions screen so users can launch the system dialogs without leaving the flow, while still blocking final completion until every grant (including DND) succeeds.

-- 2025-11-05 Update --
- Implemented end-to-end SMS delivery tracking with a new `SmsSendReceiver`, PendingIntent callbacks, and deferred completion so manual message send states reflect real modem results.
- Hardened inbound manual message handling by retrying contact resolution, guarding against ID 0 saves, and flagging outbound results as pending when the remote contact has not approved linking.
- Polished the onboarding, home, and settings composables with the latest gradients, toggle cards, and permission guidance; fixed the onboarding name field cursor jump reported by QA.
- Gradle targets `testFreeDebugUnitTest`, `testProDebugUnitTest`, and `androidApp:assembleProDebug` now pass against the refreshed branch (see `androidApp/build/outputs/apk/pro/debug/` for the updated APK).
- Reworked the contact call flow to wait for remote override confirmation, auto place the call via `ACTION_CALL`, monitor call completion, and push a `CallEnded` SMS so the receiver's audio settings restore immediately after hangup.

-- 2025-11-05 Update (Alert polish & UI) --
- Emergency quick action now dispatches alerts to ordered contacts sequentially and keeps remote ringers elevated through the follow-up call handshake.
- Contact call flow waits on the new AlertPrepare(CALL) handshake, sends CallEnded acknowledgements, and auto-restores remote audio overrides after hangup.
- Link approval screen surfaces an "Allow remote sound change" switch and respects the auto-allow setting during approval.
- Home header/logo alignment, mic toggle copy, quick actions, and reorder affordances refreshed; Settings gained a listening toggle and clearer tone entries.
- Tone pickers open as dedicated routes for emergency vs. check-in sounds with cleaned layouts and centered branding.
- Updated theme palettes and component styling to improve contrast in light/dark modes across settings, contact detail, and dialog surfaces.
- Contact import pipeline now guards permission failures and returns a user-facing toast instead of crashing.

-- 2025-11-06 Update (Release signing & Play requirements) --
- Migrated the app to API Level 35: `compileSdk = 35`, `targetSdk = 35`, `buildToolsVersion = 35.0.0`, `versionCode = 3`, `versionName = 1.0.2` to satisfy Play’s November 2025 policy.
- Introduced a release signing config that resolves credentials from Gradle `-P` flags, environment variables, or a local `keystore.properties`, defaulting to `pulselink-upload-2025.jks` when present.
- Generated a new upload key (`pulselink-upload-2025.jks`, alias `pulselink_upload`, passwords `PulseLink!Upload2025`) and exported the matching certificate (`pulselink-upload-2025.pem`) for Play App Signing enrollment.
- Added `keystore.properties.template`, kept secrets out of VCS via `.gitignore`, and committed the template so other devs can drop in their own credentials.
- Reworked `.github/workflows/release-aab.yml` so CI decodes the keystore secret, supplies signing info via env vars, and builds both `bundleFreeRelease` and `bundleProRelease` before calling `r0adkll/upload-google-play@v1`.
- Local build verification (2025-11-06 10:45 MST): `./gradlew clean bundleFreeRelease bundleProRelease assembleFreeRelease assembleProRelease`; resulting artifacts live under `androidApp/build/outputs/{bundle,apk}/**/release/` and verify with `jarsigner -verify`.
- Google Play upload still returns “The caller does not have permission”; remaining work is to link the Cloud project in Play Console, grant the service account Release Manager access to `com.pulselink.free`, and confirm the Google Play Android Developer API is enabled.

Next Immediate actions:
- Finish Play Console configuration so the new upload key/service account can create edits (link Cloud project, grant Release Manager role, enable Google Play Android Developer API).
- Address the outstanding UX polish from 2025-11-05: emergency quick action button, contact reorder drag support, tone picker separation with centered branding, link-approval toggle for “allow remote sound change”, contrast fixes, centered logo + mic toggle on Home, removal of the stray “support circle” icon, and the contact import crash.
- Re-run end-to-end smoke tests (alerts, SMS flows, contact linking) once the UI changes land, then cut the next internal track build via the refreshed GitHub workflow.
